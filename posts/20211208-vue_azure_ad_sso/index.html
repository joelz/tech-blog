<!doctype html><html><head><title>vue web app æ¥å…¥ Azure AD SSO</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content="vue web app æ¥å…¥ Azure AD SSO"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><meta property="og:url" content="https://joelz.github.io/tech-blog/posts/20211208-vue_azure_ad_sso/"><meta property="og:site_name" content="Notes by Joel"><meta property="og:title" content="vue web app æ¥å…¥ Azure AD SSO"><meta property="og:description" content="vue web app æ¥å…¥ Azure AD SSO"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-08T12:01:58+08:00"><meta property="article:modified_time" content="2021-12-08T12:01:58+08:00"><meta property="article:tag" content="Web"><meta property="article:tag" content="Sso"><meta property="article:tag" content="Azure"><meta name=twitter:card content="summary"><meta name=twitter:title content="vue web app æ¥å…¥ Azure AD SSO"><meta name=twitter:description content="vue web app æ¥å…¥ Azure AD SSO"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","abcdefghzd")</script><script src=/tech-blog/js/toc.js></script><link type=text/css rel=stylesheet href=/tech-blog/vendor/css/bootstrap.min.css><link rel=stylesheet href=/tech-blog/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/tech-blog/posts>Archive
</a><a class="a-block drawer-menu-item false" href=/tech-blog/categories>Categories
</a><a class="a-block drawer-menu-item false" href=/tech-blog/tags>Tags
</a><a class="a-block drawer-menu-item false" href=/tech-blog/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9%e5%ba%94%e7%94%a8%e6%8e%a5%e5%85%a5azure-ad-sso%e6%b5%81%e7%a8%8b class=nav-ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥azure-ad-ssoæµç¨‹>ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥Azure AD SSOæµç¨‹</a></li><li><a href=#oauth-in-azure-ad class=nav-oauth-in-azure-ad>OAuth in Azure AD</a></li><ul><li><a href=#default-access-token-%e6%98%af-jwt%e4%bd%86%e6%98%af%e6%97%a0%e6%b3%95%e9%aa%8c%e8%af%81%e7%ad%be%e5%90%8d--invalid-signature class=nav-default-access-token-æ˜¯-jwtä½†æ˜¯æ— æ³•éªŒè¯ç­¾å--invalid-signature>default access token æ˜¯ jwtï¼Œä½†æ˜¯æ— æ³•éªŒè¯ç­¾å Invalid signature</a></li><li><a href=#oidc-in-oauth class=nav-oidc-in-oauth>OIDC in OAuth</a></li></ul><li><a href=#saml-in-azure-ad class=nav-saml-in-azure-ad>SAML in Azure AD</a></li><ul><li><a href=#saml-%e9%85%8d%e7%bd%ae class=nav-saml-é…ç½®>SAML é…ç½®</a></li><li><a href=#saml-in-msaljs class=nav-saml-in-msaljs>SAML in MSAL.js?</a></li><li><a href=#%e4%be%8b%e5%ad%90 class=nav-ä¾‹å­>ä¾‹å­</a></li><ul><li><a href=#saml-101 class=nav-saml-101>SAML 101</a></li></ul></ul><li><a href=#%e4%bf%9d%e6%8a%a4api class=nav-ä¿æŠ¤api>ä¿æŠ¤API</a></li></ul><li><a href=#s%e7%ab%af%e9%9b%86%e6%88%90azure-ad-sso class=nav-sç«¯é›†æˆazure-ad-sso>Sç«¯é›†æˆAzure AD SSO</a></li><ul><li><a href=#%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5 class=nav-åŸºç¡€æ¦‚å¿µ>åŸºç¡€æ¦‚å¿µ</a></li><li><a href=#azure-ad%e4%b8%8a%e7%9a%84%e9%85%8d%e7%bd%ae class=nav-azure-adä¸Šçš„é…ç½®>Azure ADä¸Šçš„é…ç½®</a></li><li><a href=#s%e7%ab%af%e4%bb%a3%e7%a0%81%e8%af%b4%e6%98%8e class=nav-sç«¯ä»£ç è¯´æ˜>Sç«¯ä»£ç è¯´æ˜</a></li><ul><li><a href=#%e9%85%8d%e7%bd%ae%e9%a1%b9 class=nav-é…ç½®é¡¹>é…ç½®é¡¹</a></li><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96-msal-%e5%ae%9e%e4%be%8b class=nav-åˆå§‹åŒ–-msal-å®ä¾‹>åˆå§‹åŒ– MSAL å®ä¾‹</a></li><li><a href=#%e7%99%bb%e5%bd%95 class=nav-ç™»å½•>ç™»å½•</a></li><li><a href=#%e7%99%bb%e5%87%ba class=nav-ç™»å‡º>ç™»å‡º</a></li></ul><li><a href=#%e5%85%b6%e4%bb%96 class=nav-å…¶ä»–>å…¶ä»–</a></li><ul><li><a href=#%e7%99%bb%e5%bd%95%e6%8a%a5%e9%94%99pkce-not-created class=nav-ç™»å½•æŠ¥é”™pkce-not-created>ç™»å½•æŠ¥é”™ï¼špkce not created</a></li><li><a href=#%e9%94%99%e8%af%af2 class=nav-é”™è¯¯2>é”™è¯¯2</a></li></ul><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 class=nav-å‚è€ƒé“¾æ¥>å‚è€ƒé“¾æ¥</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://joelz.github.io/tech-blog/>Notes by Joel
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://joelz.github.io/tech-blog/><div class=single-column-header-title>Notes by Joel</div><div class=single-column-header-subtitle>Bytes and Bits, Piece by Piece.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style=background-image:url(https://joelz.github.io/tech-blog/images/notebook.jpg)><div class=post-title>vue web app æ¥å…¥ Azure AD SSO<div class=post-subtitle>vue web app æ¥å…¥ Azure AD SSO</div><div class=post-meta><time itemprop=datePublished>2021-12-08 12:01
</time><i class=material-icons>folder</i>
<a href=/categories/web>web</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/web>web</a>
&nbsp;
<a href=/tags/sso>sso</a>
&nbsp;
<a href=/tags/azure>azure</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥azure-ad-ssoæµç¨‹>ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥Azure AD SSOæµç¨‹</h2><ol><li>ç¡®å®šè´¦å·ä½“ç³»çš„å¯¹åº”å…³ç³»ï¼ˆSP ä¸­çš„è´¦å·å’Œ AAD ä¸­çš„å“ªä¸ªå­—æ®µå¯¹åº”ï¼‰</li><li>ç¡®å®šæ¥å…¥åè®®ï¼ˆSAML è¿˜æ˜¯ OAuthï¼‰</li><li>ç¡®å®š SP ä¸­æœ‰å“ªäº›ç±»å‹çš„åº”ç”¨è¦é›†æˆï¼ˆSAPï¼ŒWeb Appï¼ŒWeb APIï¼ŒDesktopï¼ŒMobileï¼‰</li><li>ç¡®å®šæ¥å…¥æ–¹æ¡ˆ</li><li>æ–°å»º dev AAD çš„applicationï¼Œåˆ›å»ºé…ç½®</li><li>SP æ–¹å¼€å‘å’Œæµ‹è¯•</li><li>ï¼ˆå¯é€‰ï¼‰æœ‰äº›äº‹é¡¹éœ€è¦æ‰¾é¦™æ¸¯åŒäº‹ç¡®è®¤</li><li>PROD AAD é…ç½®</li><li>SP æ–¹æµ‹è¯• PROD AAD é…ç½®æ— è¯¯</li><li>ä¸Šçº¿</li></ol><h2 id=oauth-in-azure-ad>OAuth in Azure AD</h2><p>SSO_in_Azure_AD_using_OAuth_OIDC_20220520.pptx</p><h3 id=default-access-token-æ˜¯-jwtä½†æ˜¯æ— æ³•éªŒè¯ç­¾å--invalid-signature>default access token æ˜¯ jwtï¼Œä½†æ˜¯æ— æ³•éªŒè¯ç­¾å Invalid signature</h3><p><a href=https://stackoverflow.com/questions/45317152/invalid-signature-while-validating-azure-ad-access-token-but-id-token-works>validation - Invalid signature while validating Azure ad access token, but id token works - Stack Overflow</a></p><h3 id=oidc-in-oauth>OIDC in OAuth</h3><p><a href=https://darutk.medium.com/diagrams-of-all-the-openid-connect-flows-6968e3990660>Diagrams of All The OpenID Connect Flows | by Takahiko Kawasaki | Medium</a></p><h2 id=saml-in-azure-ad>SAML in Azure AD</h2><ul><li><a href=https://auth0.com/blog/how-saml-authentication-works/>What is SAML and how does SAML Authentication Work</a></li></ul><h3 id=saml-é…ç½®>SAML é…ç½®</h3><ul><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-saml-protocol-reference>How the Microsoft identity platform uses the SAML protocol - Microsoft identity platform | Microsoft Docs</a>
-<a href=https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/auth-saml>SAML authentication with Azure Active Directory | Microsoft Docs</a></li><li><a href=https://help.aliyun.com/document_detail/312185.html>é€šè¿‡SAMLé›†æˆAzure AD</a></li><li><a href=https://cloud.tencent.com/document/product/598/35713>è®¿é—®ç®¡ç† Azure Active Directory å•ç‚¹ç™»å½•è…¾è®¯äº‘æŒ‡å—-ç”¨æˆ·æŒ‡å—-æ–‡æ¡£ä¸­å¿ƒ-è…¾è®¯äº‘-è…¾è®¯äº‘</a></li></ul><h3 id=saml-in-msaljs>SAML in MSAL.js?</h3><ul><li><a href=https://github.com/AzureAD/microsoft-authentication-library-for-java/issues/329>What about supporting SAML 2.0 in this library? Â· Issue #329 Â· AzureAD/microsoft-authentication-library-for-java</a></li><li><a href=https://stackoverflow.com/questions/63495395/acquire-a-saml-token-in-msal-js>jwt - Acquire a SAML token in MSAL.js - Stack Overflow</a>ï¼š</li></ul><blockquote><p>Also ,<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/single-sign-on-saml-protocol>Single Sign-On SAML protocol</a> and <a href=https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-fed-saml-idp>Federated Authentication with a SAML Identity Provider</a> should be good starting points to implement SAML directly.</p></blockquote><h3 id=ä¾‹å­>ä¾‹å­</h3><p>ä¾‹å­ï¼ˆé‡Œé¢è¿˜æœ‰ç”¨azure saml çš„ç¤ºä¾‹ï¼Œéƒ¨ç½²åœ¨ <a href=https://aad-saml.glitch.me/>https://aad-saml.glitch.me/</a> ï¼‰ï¼šhttps://github.com/joelz/certificates-sample</p><p>asp.net å¯ä»¥ç”¨çš„åº“ï¼š<a href="https://github.com/jitbit/AspNetSaml?tab=readme-ov-file">jitbit/AspNetSaml: Very simple SAML 2.0 consumer module for ASP.NET/C#</a></p><h4 id=saml-101>SAML 101</h4><ul><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/single-sign-on-saml-protocol>Azure Single Sign On SAML Protocol - Microsoft identity platform | Microsoft Docs</a></li><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal-setup-sso>Quickstart: Set up SAML-based single sign-on (SSO) for an application in your Azure Active Directory (Azure AD) tenant | Microsoft Docs</a></li><li><a href=https://learning.postman.com/docs/administration/sso/saml-in-azure-ad/>Custom SAML in Azure AD | Postman Learning Center</a></li><li><a href=https://matthijs.hoekstraonline.net/2020/04/14/authenticate-an-azure-ad-user-with-saml-for-asp-net-core/>Authenticate an Azure AD user with SAML for ASP.NET Core - Matthijs&rsquo;s Blog</a></li><li><a href=https://cmatskas.com/asp-net-core-saml-authentication-with-azure-ad/>ASP.NET Core SAML Authentication with Azure AD</a></li><li><a href=https://stackoverflow.com/questions/55408087/azure-single-sign-on-using-saml-2-0-protocol-and-asp-net-c-sharp>Azure Single Sign-On using SAML 2.0 Protocol and ASP.NET C# - Stack Overflow</a></li></ul><h2 id=ä¿æŠ¤api>ä¿æŠ¤API</h2><p>è‡ªå®šä¹‰scopeï¼Œæˆ–è€…è‡ªå®šä¹‰ app rolesã€‚</p><p><a href=https://stackoverflow.com/questions/50128504/how-to-control-set-permissions-for-a-single-user-when-using-azure-ad-b2c>oauth 2.0 - How to control/set permissions for a single user when using Azure AD B2C - Stack Overflow</a>
<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps>Add app roles and get them from a token - Microsoft identity platform | Microsoft Docs</a></p><p>ğŸ‘‡ä¸‹é¢çš„è¯´æ³•ä¸å¯¹ã€‚</p><p>=====</p><p>æ‹¿åˆ°access_token å»è®¿é—® resource ownerï¼Œæ€ä¹ˆçŸ¥é“æƒé™å‘¢ï¼Ÿscopeã€‚
kip é‡Œé¢æ‹¿åˆ°acess_tokenï¼Œä»ç„¶æ˜¯å»æ‰¾ microsoft graph é—®ä»–æ˜¯è°ï¼Œéš¾é“ ms graph æ˜¯ä¸€ä¸ª resource ownerï¼Ÿå¯¹çš„ã€‚æ‰€ä»¥Azure Portal ä¸­é…ç½® Application æ—¶éœ€è¦åœ¨ API Permissions ä¸­æ›´åŠ ä¸ŠMS Graph ç›¸å…³çš„ Permission</p><p>è‡ªå·±çš„Appï¼ˆå³resource ownerï¼Œç®€ç§°ROï¼‰ä¸­è¦åŠ æƒé™æ§åˆ¶ï¼Œæ•´ä¸ªé…ç½®çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ä¸ºclient appæ³¨å†Œapplicationï¼š<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app>Quickstart: Register an app in the Microsoft identity platform - Microsoft identity platform | Microsoft Docs</a></li><li>ä¸ºROé…ç½®æƒé™ã€‚æ–‡æ¡£ä¸­å«Expose an APIï¼Œå¯ä»¥ç†è§£ä¸ºROæ˜¯ä¸€ä¸ªå¤§çš„APIï¼Œä¸åŒæƒé™å¯¹åº”ä¸åŒçš„scopeã€‚æ·»åŠ scopeï¼š<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis>Quickstart: Register and expose a web API - Microsoft identity platform | Microsoft Docs</a></li><li>ä¸ºROæ·»åŠ çš„permissionï¼ŒåŒ…æ‹¬äº†å¾®è½¯æä¾›çš„ä¸€äº›permissionï¼ˆæ¯”å¦‚ MS Graph çš„permissionï¼‰å’Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„scopeå¯¹åº”çš„permissionï¼š<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-access-web-apis>Quickstart: Configure an app to access a web API - Microsoft identity platform | Microsoft Doc</a></li></ol><h1 id=sç«¯é›†æˆazure-ad-sso>Sç«¯é›†æˆAzure AD SSO</h1><h2 id=åŸºç¡€æ¦‚å¿µ>åŸºç¡€æ¦‚å¿µ</h2><ol><li>Azure ADæ˜¯å¾®è½¯æä¾›çš„äº‘æœåŠ¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤šç§Ÿæˆ·ç³»ç»Ÿã€‚å…¬å¸æ˜¯Azure ADçš„ä¸€ä¸ªç§Ÿæˆ·ï¼ˆæˆ–è€…å«åŸŸï¼‰ï¼Œå¯¹åº”çš„ç§Ÿæˆ·åç§°æ˜¯kerryprops.comã€‚æˆ‘ä»¬å¼€å‘æ—¶ä¼šä½¿ç”¨ä¸€ä¸ªæµ‹è¯•ç”¨çš„ç§Ÿæˆ·ï¼Œç§Ÿæˆ·åç§°ä¸ºkpltest.onmicrosoft.comã€‚</li><li>SSOï¼šå•ç‚¹ç™»å½•ã€‚æ•´ä¸ªå•ç‚¹ç™»å½•è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠåˆ°ç”¨æˆ·ã€èº«ä»½æä¾›å•†ï¼ˆIdentity Providerï¼Œç®€ç§°IdPï¼‰å’ŒæœåŠ¡æä¾›å•†ï¼ˆService Providerï¼Œç®€ç§°SPï¼‰ã€‚åœ¨Sç«¯ç”¨æˆ·ç™»å½•è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒAzure AD æ˜¯ IdPï¼ŒSç«¯æ˜¯SPåŒæ—¶ä¹Ÿæ˜¯IdPï¼ˆå› ä¸ºæˆ‘ä»¬æœ‰è‡ªå·±çš„Profile Serviceï¼‰ã€‚æ•´ä¸ªSSOçš„ç›®çš„å°±æ˜¯ç”¨Azure ADçš„tokenå»æ¢å›Sç«¯çš„tokenï¼ˆå› ä¸ºè°ƒç”¨åç«¯Service APIä½¿ç”¨çš„æ˜¯Sç«¯çš„tokenï¼Œè€ŒéAzure ADçš„tokenï¼‰</li><li>æ¶‰åŠåˆ°å¤šä¸ª IdP çš„ SSO æœ‰å¾ˆå¤šæ–¹å¼å¯ä»¥å®ç°ï¼Œæ¯”å¦‚ SAML 2.0ï¼ŒWS-Federationï¼ŒOpenID Connectï¼ˆOIDCï¼‰å’Œ OAuthã€‚Sç«¯æ˜¯ä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„å•é¡µåº”ç”¨ï¼ˆSPAï¼‰ï¼Œé‡‡ç”¨çš„æ˜¯<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-overview#overview>OAuth 2.0 Authorization code flow (with PKCE)</a>ã€‚é¡µé¢è¯·æ±‚é¡ºåºå¦‚ä¸‹å›¾ï¼š
<img src=./assets/admin-portal-sso.png alt=admin-portal-sso.png></li><li>MSALåº“ï¼šMicrosoft Authentication Libraryï¼Œå¾®è½¯å®˜æ–¹å‡ºå“çš„ç±»åº“ï¼Œå¯æ–¹ä¾¿åœ°å¤„ç†ä½¿ç”¨Azure ADåšSSOçš„å„ç±»åœºæ™¯ã€‚æœ‰å„ç§è¯­è¨€çš„ç‰ˆæœ¬ã€‚JavaScriptè¯­è¨€çš„ç‰ˆæœ¬å« <a href=https://github.com/AzureAD/microsoft-authentication-library-for-js>MSAL.js</a></li></ol><h2 id=azure-adä¸Šçš„é…ç½®>Azure ADä¸Šçš„é…ç½®</h2><p>è¿™éƒ¨åˆ†éœ€è¦Azure ADçš„ç®¡ç†å‘˜æ‰èƒ½é…ç½®ã€‚ç®¡ç†å‘˜ç™»å½•åˆ°Azure AD Portal: <a href=https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade>https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade</a></p><blockquote><p>å¦‚æœæƒ³è‡ªå·±å°è¯•é…ç½®å’Œç®¡ç†ä¸€ä¸ªAzure ADçš„ç§Ÿæˆ·ï¼Œå¯ä»¥ç”¨ä¸ªäººçš„å¾®è½¯è´¦å·ï¼ˆæ¯”å¦‚live.com/hotmail.com/outlook.com é‚®ç®±è´¦å·ï¼‰å»ç”³è¯·<a href=https://developer.microsoft.com/en-us/microsoft-365/dev-program>Microsoft 365 Developer Program</a>ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªå…è´¹çš„Azure ADç§Ÿæˆ·ã€‚</p></blockquote><h2 id=sç«¯ä»£ç è¯´æ˜>Sç«¯ä»£ç è¯´æ˜</h2><p>ä½¿ç”¨çš„npm pacakgeï¼š<a href=https://www.npmjs.com/package/@azure/msal-browser>@azure/msal-browser - npm</a>ï¼ˆå°±æ˜¯ä¸Šæ–‡è¯´åˆ°çš„ MSAL.js ï¼‰</p><h3 id=é…ç½®é¡¹>é…ç½®é¡¹</h3><p>é…ç½®é¡¹å†™åœ¨ <code>src/store/modules/user.js</code> ä¸­ï¼š</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#c1abea>msalLoginRequest</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#c1abea>scopes</span><span style=color:#c7bf54>:</span> [<span style=color:#98c379>&#39;openid&#39;</span>, <span style=color:#98c379>&#39;profile&#39;</span>, <span style=color:#98c379>&#39;User.Read&#39;</span>], <span style=color:#8a93a5;font-style:italic>// å¯¹åº”ä¸Šæ–‡ä¸­çš„ API Permissions
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    },
</span></span><span style=display:flex><span>    <span style=color:#c1abea>msalUseRedirect</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>process</span>.<span style=color:#c1abea>env</span>.<span style=color:#c1abea>VUE_APP_AZURE_USE_REDIRECT</span> <span style=color:#c7bf54>==</span> <span style=color:#98c379>&#39;true&#39;</span>, <span style=color:#8a93a5;font-style:italic>// å‚è§ä¸‹æ–‡è¯´æ˜1
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c1abea>msalConfig</span><span style=color:#c7bf54>:</span> { <span style=color:#8a93a5;font-style:italic>// å‚è§ä¸‹æ–‡è¯´æ˜2
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>      <span style=color:#c1abea>auth</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>clientId</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>getAzureConfig</span>().<span style=color:#c1abea>clientId</span>,
</span></span><span style=display:flex><span>        <span style=color:#c1abea>authority</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>getAzureConfig</span>().<span style=color:#c1abea>authority</span>, <span style=color:#8a93a5;font-style:italic>// é‡Œé¢æœ‰tenantId
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#c1abea>navigateToLoginRequestUrl</span><span style=color:#c7bf54>:</span> <span style=color:#b756ff;font-weight:700>false</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#c1abea>cache</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>cacheLocation</span><span style=color:#c7bf54>:</span> <span style=color:#98c379>&#39;localStorage&#39;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ol><li>è¿™ä¸ªé€‰é¡¹æ˜¯ç”¨æ¥æ§åˆ¶æµè§ˆå™¨ä»Sç«¯ç™»å½•é¡µåˆ°Azure ADç™»å½•é¡µæ—¶ä½¿ç”¨è·³è½¬è¿˜æ˜¯å¼¹çª—ã€‚å‚è€ƒè¿™é‡Œï¼šhttps://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-sign-in?tabs=javascript2#choosing-between-a-pop-up-or-redirect-experience</li><li>Configuration Optionså®Œæ•´æ–‡æ¡£åœ¨è¿™é‡Œï¼šhttps://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/configuration.md</li></ol><h3 id=åˆå§‹åŒ–-msal-å®ä¾‹>åˆå§‹åŒ– MSAL å®ä¾‹</h3><p>åœ¨ <code>src/main.js</code> ä¸­ï¼š</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#c1abea>Vue</span>.<span style=color:#c1abea>prototype</span>.<span style=color:#c1abea>$msalInstance</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>PublicClientApplication</span>(
</span></span><span style=display:flex><span>  <span style=color:#c1abea>store</span>.<span style=color:#c1abea>state</span>.<span style=color:#c1abea>user</span>.<span style=color:#c1abea>msalConfig</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><h3 id=ç™»å½•>ç™»å½•</h3><p>åœ¨ <code>src/views/login.vue</code> ä¸­ï¼š</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">99
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>mounted</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// ....
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// å¦‚æœä»Sç«¯ç™»å½•é¡µåˆ°Azure ADç™»å½•é¡µæ—¶ä½¿ç”¨è·³è½¬æ–¹å¼ï¼Œå½“ç”¨æˆ·åœ¨Azure ADç™»å½•æˆåŠŸæ—¶
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// æµè§ˆå™¨ä¼šè·³è½¬ä¼š /loginï¼ŒåŒæ—¶urlä¸­ä¼šå¸¦ä¸Š#code=xxxxxï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// ä»codeçš„å€¼ä¸­å¯ç”¨è§£æå‡ºAzure ADçš„token
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>if</span> (<span style=color:#c678dd>this</span>.<span style=color:#c1abea>$store</span>.<span style=color:#c1abea>state</span>.<span style=color:#c1abea>user</span>.<span style=color:#c1abea>msalUseRedirect</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>code</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>document</span>.<span style=color:#c1abea>location</span>.<span style=color:#c1abea>href</span>.<span style=color:#c1abea>split</span>(<span style=color:#98c379>&#39;#&#39;</span>).<span style=color:#c1abea>pop</span>();
</span></span><span style=display:flex><span>      <span style=color:#c678dd>if</span> (<span style=color:#c1abea>code</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c1abea>code</span>.<span style=color:#c1abea>indexOf</span>(<span style=color:#98c379>&#39;code=&#39;</span>) <span style=color:#c7bf54>===</span> <span style=color:#d19a66>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#39;AAD_SSO&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#39;Find auth code in path, starting handleRedirectPromise...&#39;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>
</span></span><span style=display:flex><span>          .<span style=color:#c1abea>handleRedirectPromise</span>()
</span></span><span style=display:flex><span>          .<span style=color:#c1abea>then</span>((<span style=color:#c1abea>resp</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(
</span></span><span style=display:flex><span>              <span style=color:#98c379>&#39;AAD_SSO&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#98c379>&#39;handleRedirectPromise on mounted done&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#c1abea>resp</span>
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#c678dd>let</span> <span style=color:#c1abea>accessToken</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>resp</span>.<span style=color:#c1abea>accessToken</span>;
</span></span><span style=display:flex><span>            <span style=color:#c678dd>this</span>.<span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>          })
</span></span><span style=display:flex><span>          .<span style=color:#c678dd>catch</span>((<span style=color:#c1abea>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#c1abea>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#c1abea>methods</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// acquireTokenSilentï¼ŒæˆåŠŸåˆ™è°ƒç”¨ä¸‹é¢çš„msalLoginï¼›
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// å¤±è´¥åˆ™è°ƒç”¨ getMsalAccessTokenViaInteractiveMode
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// ç›®å‰æœªç”¨åˆ°
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>async</span> <span style=color:#c1abea>getMsalAccessToken</span>(<span style=color:#c1abea>account</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>request</span> <span style=color:#c7bf54>=</span> { <span style=color:#8a93a5;font-style:italic>// // å‚è§ä¸‹æ–‡è¯´æ˜1
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#c1abea>scopes</span><span style=color:#c7bf54>:</span> [<span style=color:#98c379>&#39;User.Read&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#c1abea>prompt</span><span style=color:#c7bf54>:</span> <span style=color:#98c379>&#39;select_account&#39;</span>,
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>let</span> <span style=color:#c1abea>tokenResponse</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>.<span style=color:#c1abea>acquireTokenSilent</span>(
</span></span><span style=display:flex><span>          <span style=color:#c1abea>request</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(<span style=color:#98c379>&#39;setAccessToken&#39;</span>, <span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>      } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#c1abea>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#39;Silent token acquisition failed. Using interactive mode&#39;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>getMsalAccessTokenViaInteractiveMode</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// äº¤äº’æ¨¡å¼ç™»å½•ï¼šå¼¹çª—æˆ–è€…è·³è½¬åˆ°Azure ADç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•ï¼Œè·å–åˆ°Azure ADçš„token
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>async</span> <span style=color:#c1abea>getMsalAccessTokenViaInteractiveMode</span>() {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#8a93a5;font-style:italic>// https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/request-response-object.md
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>request</span> <span style=color:#c7bf54>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>scopes</span><span style=color:#c7bf54>:</span> [<span style=color:#98c379>&#39;User.Read&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#c1abea>prompt</span><span style=color:#c7bf54>:</span> <span style=color:#98c379>&#39;select_account&#39;</span>,
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#c1abea>console</span>.<span style=color:#c1abea>info</span>(
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;Using interactive mode to msal get access token...&#39;</span>
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#c678dd>if</span> (<span style=color:#c678dd>this</span>.<span style=color:#c1abea>$store</span>.<span style=color:#c1abea>state</span>.<span style=color:#c1abea>user</span>.<span style=color:#c1abea>msalUseRedirect</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>.<span style=color:#c1abea>acquireTokenRedirect</span>(<span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>      } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>let</span> <span style=color:#c1abea>tokenResponse</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>.<span style=color:#c1abea>acquireTokenPopup</span>(
</span></span><span style=display:flex><span>          <span style=color:#c1abea>request</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(
</span></span><span style=display:flex><span>          <span style=color:#98c379>`Access token acquired via interactive auth </span><span style=color:#98c379>${</span><span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span><span style=color:#98c379>}</span><span style=color:#98c379>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// è°ƒç”¨profile serivceæ¥å£ï¼Œç”¨Azure ADçš„tokenå»è·å–Sç«¯å¯ç”¨çš„token
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// å®Œæˆç™»å½•è¿‡ç¨‹
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// Azure ADçš„tokenå¯ä»¥ç”¨å¾®è½¯æä¾›çš„æ¥å£ https://graph.microsoft.com/v1.0/me æ¥éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>async</span> <span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>msalAccessToken</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$store</span>
</span></span><span style=display:flex><span>        .<span style=color:#c1abea>dispatch</span>(<span style=color:#98c379>&#39;MsalLogin&#39;</span>, <span style=color:#c1abea>msalAccessToken</span>)
</span></span><span style=display:flex><span>        .<span style=color:#c1abea>then</span>(() =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(<span style=color:#98c379>&#39;Msal login finally done!!!&#39;</span>);
</span></span><span style=display:flex><span>          <span style=color:#8a93a5;font-style:italic>// ã€‚ã€‚ã€‚ã€‚
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        })
</span></span><span style=display:flex><span>        .<span style=color:#c678dd>catch</span>((<span style=color:#c1abea>e</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>          <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  },   
</span></span></code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼š</p><ol><li>Request å’Œ Response å¯¹è±¡çš„å®Œæ•´æ–‡æ¡£åœ¨è¿™é‡Œï¼šhttps://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/request-response-object.md</li></ol><h3 id=ç™»å‡º>ç™»å‡º</h3><p>ç™»å‡ºæ—¶ä¸æ¶‰åŠAzure ADçš„ç™»å‡ºï¼Œåªæ˜¯åˆ é™¤Sç«¯è‡ªå·±çš„tokenå³å¯ã€‚</p><h2 id=å…¶ä»–>å…¶ä»–</h2><h3 id=ç™»å½•æŠ¥é”™pkce-not-created>ç™»å½•æŠ¥é”™ï¼špkce not created</h3><p>by yuyang in SKCã€‚é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p><pre tabindex=0><code>uncaught (in promise) BrowserAuthError:app.24961a1a.j5:141

pkce not created: The PKCE code challenge and verifier could not be generated. Detail TypeError: Cannot read property &#39;digest&#39; of undefined at t les constructor@ (https: //static.kerryprops.com.cn/kip/kip-admin-portel/static/is/app.24361ale-j9:141:4139)

at newt (nttpst//statickerryprops.com.en/kip/kip-admin-portal/static/js/app.496181a.45/141/225355

at Function.t, createPkceNotGeneratedError (https://static.kerryprops.com.cn/kip/kip-admin-pontal/static/is/app.24961ala.js:141:22692)

at e-sanonymous&gt;/(https://static.kerryprops.com.cn/kip/kip-admin-portal/
</code></pre><p>åŸå› ï¼š
ç”¨æˆ·æ²¡æœ‰ä½¿ç”¨httpsé“¾æ¥ç™»å½•Sç«¯ã€‚ä½¿ç”¨ <a href=https://admin.kerryplus.com>https://admin.kerryplus.com</a> è®¿é—®ç™»å½•æˆåŠŸã€‚</p><h3 id=é”™è¯¯2>é”™è¯¯2</h3><p><a href=https://learn.microsoft.com/en-us/answers/questions/1194524/how-to-fix-aadsts9002325-proof-key-for-code-exchan>How to fix AADSTS9002325: Proof Key for Code Exchange is required for cross-origin authorization code redemption error in msal react application. - Microsoft Q&amp;A</a></p><h2 id=å‚è€ƒé“¾æ¥>å‚è€ƒé“¾æ¥</h2><ul><li><a href=https://devblogs.microsoft.com/azure-sdk/vue-js-user-authentication/>Vue.js User Authentication and the new Azure SDKs - Azure SDK Blog</a></li><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications>Initialize MSAL.js client apps - Microsoft identity platform | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-sign-in?tabs=javascript2">Single-page app sign-in & sign-out - Microsoft identity platform | Microsoft Docs</a></li></ul><hr width=100% id=EOF><p style=color:#777>Last modified on 2021-12-08</p></div></div><nav class=post-pagination><a class=newer-posts href=/tech-blog/posts/20220418-weixin_mp_webview/>Next<br>å°ç¨‹åºåŠAppå†…åµŒH5
</a><a class=older-posts href=/tech-blog/posts/20211105-aliyun_arms/>Previous<br>uni-app å¤šç«¯é¡¹ç›®æ¥å…¥é˜¿é‡Œäº‘ ARMS</a></nav><div class=post-comment-wrapper><p style=opacity:.6 align=center><small>Comments Disabled.</small></p></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://joelz.github.io/tech-blog/><div class=nav-title>Notes by Joel</div><div class=nav-subtitle>Bytes and Bits, Piece by Piece.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/tech-blog/posts>Archive
</a><a class="a-block nav-link-item false" href=/tech-blog/categories>Categories
</a><a class="a-block nav-link-item false" href=/tech-blog/tags>Tags
</a><a class="a-block nav-link-item false" href=/tech-blog/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copy, right? ğŸ¤”</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9%e5%ba%94%e7%94%a8%e6%8e%a5%e5%85%a5azure-ad-sso%e6%b5%81%e7%a8%8b class=nav-ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥azure-ad-ssoæµç¨‹>ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥Azure AD SSOæµç¨‹</a></li><li><a href=#oauth-in-azure-ad class=nav-oauth-in-azure-ad>OAuth in Azure AD</a></li><ul><li><a href=#default-access-token-%e6%98%af-jwt%e4%bd%86%e6%98%af%e6%97%a0%e6%b3%95%e9%aa%8c%e8%af%81%e7%ad%be%e5%90%8d--invalid-signature class=nav-default-access-token-æ˜¯-jwtä½†æ˜¯æ— æ³•éªŒè¯ç­¾å--invalid-signature>default access token æ˜¯ jwtï¼Œä½†æ˜¯æ— æ³•éªŒè¯ç­¾å Invalid signature</a></li><li><a href=#oidc-in-oauth class=nav-oidc-in-oauth>OIDC in OAuth</a></li></ul><li><a href=#saml-in-azure-ad class=nav-saml-in-azure-ad>SAML in Azure AD</a></li><ul><li><a href=#saml-%e9%85%8d%e7%bd%ae class=nav-saml-é…ç½®>SAML é…ç½®</a></li><li><a href=#saml-in-msaljs class=nav-saml-in-msaljs>SAML in MSAL.js?</a></li><li><a href=#%e4%be%8b%e5%ad%90 class=nav-ä¾‹å­>ä¾‹å­</a></li><ul><li><a href=#saml-101 class=nav-saml-101>SAML 101</a></li></ul></ul><li><a href=#%e4%bf%9d%e6%8a%a4api class=nav-ä¿æŠ¤api>ä¿æŠ¤API</a></li></ul><li><a href=#s%e7%ab%af%e9%9b%86%e6%88%90azure-ad-sso class=nav-sç«¯é›†æˆazure-ad-sso>Sç«¯é›†æˆAzure AD SSO</a></li><ul><li><a href=#%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5 class=nav-åŸºç¡€æ¦‚å¿µ>åŸºç¡€æ¦‚å¿µ</a></li><li><a href=#azure-ad%e4%b8%8a%e7%9a%84%e9%85%8d%e7%bd%ae class=nav-azure-adä¸Šçš„é…ç½®>Azure ADä¸Šçš„é…ç½®</a></li><li><a href=#s%e7%ab%af%e4%bb%a3%e7%a0%81%e8%af%b4%e6%98%8e class=nav-sç«¯ä»£ç è¯´æ˜>Sç«¯ä»£ç è¯´æ˜</a></li><ul><li><a href=#%e9%85%8d%e7%bd%ae%e9%a1%b9 class=nav-é…ç½®é¡¹>é…ç½®é¡¹</a></li><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96-msal-%e5%ae%9e%e4%be%8b class=nav-åˆå§‹åŒ–-msal-å®ä¾‹>åˆå§‹åŒ– MSAL å®ä¾‹</a></li><li><a href=#%e7%99%bb%e5%bd%95 class=nav-ç™»å½•>ç™»å½•</a></li><li><a href=#%e7%99%bb%e5%87%ba class=nav-ç™»å‡º>ç™»å‡º</a></li></ul><li><a href=#%e5%85%b6%e4%bb%96 class=nav-å…¶ä»–>å…¶ä»–</a></li><ul><li><a href=#%e7%99%bb%e5%bd%95%e6%8a%a5%e9%94%99pkce-not-created class=nav-ç™»å½•æŠ¥é”™pkce-not-created>ç™»å½•æŠ¥é”™ï¼špkce not created</a></li><li><a href=#%e9%94%99%e8%af%af2 class=nav-é”™è¯¯2>é”™è¯¯2</a></li></ul><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 class=nav-å‚è€ƒé“¾æ¥>å‚è€ƒé“¾æ¥</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copy, right? ğŸ¤”</div></div><script src=/tech-blog/js/journal.js></script></body></html>