<!doctype html><html><head><title>vue web app 接入 Azure AD SSO</title>
<meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content="vue web app 接入 Azure AD SSO"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><meta property="og:url" content="https://joelz.github.io/tech-blog/posts/20211208-vue_azure_ad_sso/"><meta property="og:site_name" content="Notes by Joel"><meta property="og:title" content="vue web app 接入 Azure AD SSO"><meta property="og:description" content="vue web app 接入 Azure AD SSO"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-08T12:01:58+08:00"><meta property="article:modified_time" content="2021-12-08T12:01:58+08:00"><meta property="article:tag" content="Web"><meta property="article:tag" content="Sso"><meta property="article:tag" content="Azure"><meta name=twitter:card content="summary"><meta name=twitter:title content="vue web app 接入 Azure AD SSO"><meta name=twitter:description content="vue web app 接入 Azure AD SSO"><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","abcdefghzd")</script><script src=/tech-blog/js/toc.js></script><link type=text/css rel=stylesheet href=/tech-blog/vendor/css/bootstrap.min.css><link rel=stylesheet href=/tech-blog/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/tech-blog/posts>Archive
</a><a class="a-block drawer-menu-item false" href=/tech-blog/categories>Categories
</a><a class="a-block drawer-menu-item false" href=/tech-blog/tags>Tags
</a><a class="a-block drawer-menu-item false" href=/tech-blog/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9%e5%ba%94%e7%94%a8%e6%8e%a5%e5%85%a5azure-ad-sso%e6%b5%81%e7%a8%8b class=nav-第三方应用接入azure-ad-sso流程>第三方应用接入Azure AD SSO流程</a></li><li><a href=#oauth-in-azure-ad class=nav-oauth-in-azure-ad>OAuth in Azure AD</a></li><ul><li><a href=#default-access-token-%e6%98%af-jwt%e4%bd%86%e6%98%af%e6%97%a0%e6%b3%95%e9%aa%8c%e8%af%81%e7%ad%be%e5%90%8d--invalid-signature class=nav-default-access-token-是-jwt但是无法验证签名--invalid-signature>default access token 是 jwt，但是无法验证签名 Invalid signature</a></li><li><a href=#oidc-in-oauth class=nav-oidc-in-oauth>OIDC in OAuth</a></li></ul><li><a href=#saml-in-azure-ad class=nav-saml-in-azure-ad>SAML in Azure AD</a></li><ul><li><a href=#saml-%e9%85%8d%e7%bd%ae class=nav-saml-配置>SAML 配置</a></li><li><a href=#saml-in-msaljs class=nav-saml-in-msaljs>SAML in MSAL.js?</a></li><li><a href=#%e4%be%8b%e5%ad%90 class=nav-例子>例子</a></li><ul><li><a href=#saml-101 class=nav-saml-101>SAML 101</a></li></ul></ul><li><a href=#%e4%bf%9d%e6%8a%a4api class=nav-保护api>保护API</a></li></ul><li><a href=#s%e7%ab%af%e9%9b%86%e6%88%90azure-ad-sso class=nav-s端集成azure-ad-sso>S端集成Azure AD SSO</a></li><ul><li><a href=#%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5 class=nav-基础概念>基础概念</a></li><li><a href=#azure-ad%e4%b8%8a%e7%9a%84%e9%85%8d%e7%bd%ae class=nav-azure-ad上的配置>Azure AD上的配置</a></li><li><a href=#s%e7%ab%af%e4%bb%a3%e7%a0%81%e8%af%b4%e6%98%8e class=nav-s端代码说明>S端代码说明</a></li><ul><li><a href=#%e9%85%8d%e7%bd%ae%e9%a1%b9 class=nav-配置项>配置项</a></li><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96-msal-%e5%ae%9e%e4%be%8b class=nav-初始化-msal-实例>初始化 MSAL 实例</a></li><li><a href=#%e7%99%bb%e5%bd%95 class=nav-登录>登录</a></li><li><a href=#%e7%99%bb%e5%87%ba class=nav-登出>登出</a></li></ul><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li><ul><li><a href=#%e7%99%bb%e5%bd%95%e6%8a%a5%e9%94%99pkce-not-created class=nav-登录报错pkce-not-created>登录报错：pkce not created</a></li><li><a href=#%e9%94%99%e8%af%af2 class=nav-错误2>错误2</a></li></ul><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 class=nav-参考链接>参考链接</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu
</i></button>
<a id=navTitle class=navbar-brand href=https://joelz.github.io/tech-blog/>Notes by Joel
</a><button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://joelz.github.io/tech-blog/><div class=single-column-header-title>Notes by Joel</div><div class=single-column-header-subtitle>Bytes and Bits, Piece by Piece.</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style=background-image:url(https://joelz.github.io/tech-blog/images/notebook.jpg)><div class=post-title>vue web app 接入 Azure AD SSO<div class=post-subtitle>vue web app 接入 Azure AD SSO</div><div class=post-meta><time itemprop=datePublished>2021-12-08 12:01
</time><i class=material-icons>folder</i>
<a href=/categories/web>web</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/web>web</a>
&nbsp;
<a href=/tags/sso>sso</a>
&nbsp;
<a href=/tags/azure>azure</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=第三方应用接入azure-ad-sso流程>第三方应用接入Azure AD SSO流程</h2><ol><li>确定账号体系的对应关系（SP 中的账号和 AAD 中的哪个字段对应）</li><li>确定接入协议（SAML 还是 OAuth）</li><li>确定 SP 中有哪些类型的应用要集成（SAP，Web App，Web API，Desktop，Mobile）</li><li>确定接入方案</li><li>新建 dev AAD 的application，创建配置</li><li>SP 方开发和测试</li><li>（可选）有些事项需要找香港同事确认</li><li>PROD AAD 配置</li><li>SP 方测试 PROD AAD 配置无误</li><li>上线</li></ol><h2 id=oauth-in-azure-ad>OAuth in Azure AD</h2><p>SSO_in_Azure_AD_using_OAuth_OIDC_20220520.pptx</p><h3 id=default-access-token-是-jwt但是无法验证签名--invalid-signature>default access token 是 jwt，但是无法验证签名 Invalid signature</h3><p><a href=https://stackoverflow.com/questions/45317152/invalid-signature-while-validating-azure-ad-access-token-but-id-token-works>validation - Invalid signature while validating Azure ad access token, but id token works - Stack Overflow</a></p><h3 id=oidc-in-oauth>OIDC in OAuth</h3><p><a href=https://darutk.medium.com/diagrams-of-all-the-openid-connect-flows-6968e3990660>Diagrams of All The OpenID Connect Flows | by Takahiko Kawasaki | Medium</a></p><h2 id=saml-in-azure-ad>SAML in Azure AD</h2><ul><li><a href=https://auth0.com/blog/how-saml-authentication-works/>What is SAML and how does SAML Authentication Work</a></li></ul><h3 id=saml-配置>SAML 配置</h3><ul><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-saml-protocol-reference>How the Microsoft identity platform uses the SAML protocol - Microsoft identity platform | Microsoft Docs</a>
-<a href=https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/auth-saml>SAML authentication with Azure Active Directory | Microsoft Docs</a></li><li><a href=https://help.aliyun.com/document_detail/312185.html>通过SAML集成Azure AD</a></li><li><a href=https://cloud.tencent.com/document/product/598/35713>访问管理 Azure Active Directory 单点登录腾讯云指南-用户指南-文档中心-腾讯云-腾讯云</a></li></ul><h3 id=saml-in-msaljs>SAML in MSAL.js?</h3><ul><li><a href=https://github.com/AzureAD/microsoft-authentication-library-for-java/issues/329>What about supporting SAML 2.0 in this library? · Issue #329 · AzureAD/microsoft-authentication-library-for-java</a></li><li><a href=https://stackoverflow.com/questions/63495395/acquire-a-saml-token-in-msal-js>jwt - Acquire a SAML token in MSAL.js - Stack Overflow</a>：</li></ul><blockquote><p>Also ,<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/single-sign-on-saml-protocol>Single Sign-On SAML protocol</a> and <a href=https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-fed-saml-idp>Federated Authentication with a SAML Identity Provider</a> should be good starting points to implement SAML directly.</p></blockquote><h3 id=例子>例子</h3><p>例子（里面还有用azure saml 的示例，部署在 <a href=https://aad-saml.glitch.me/>https://aad-saml.glitch.me/</a> ）：https://github.com/joelz/certificates-sample</p><p>asp.net 可以用的库：<a href="https://github.com/jitbit/AspNetSaml?tab=readme-ov-file">jitbit/AspNetSaml: Very simple SAML 2.0 consumer module for ASP.NET/C#</a></p><h4 id=saml-101>SAML 101</h4><ul><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/single-sign-on-saml-protocol>Azure Single Sign On SAML Protocol - Microsoft identity platform | Microsoft Docs</a></li><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/add-application-portal-setup-sso>Quickstart: Set up SAML-based single sign-on (SSO) for an application in your Azure Active Directory (Azure AD) tenant | Microsoft Docs</a></li><li><a href=https://learning.postman.com/docs/administration/sso/saml-in-azure-ad/>Custom SAML in Azure AD | Postman Learning Center</a></li><li><a href=https://matthijs.hoekstraonline.net/2020/04/14/authenticate-an-azure-ad-user-with-saml-for-asp-net-core/>Authenticate an Azure AD user with SAML for ASP.NET Core - Matthijs&rsquo;s Blog</a></li><li><a href=https://cmatskas.com/asp-net-core-saml-authentication-with-azure-ad/>ASP.NET Core SAML Authentication with Azure AD</a></li><li><a href=https://stackoverflow.com/questions/55408087/azure-single-sign-on-using-saml-2-0-protocol-and-asp-net-c-sharp>Azure Single Sign-On using SAML 2.0 Protocol and ASP.NET C# - Stack Overflow</a></li></ul><h2 id=保护api>保护API</h2><p>自定义scope，或者自定义 app roles。</p><p><a href=https://stackoverflow.com/questions/50128504/how-to-control-set-permissions-for-a-single-user-when-using-azure-ad-b2c>oauth 2.0 - How to control/set permissions for a single user when using Azure AD B2C - Stack Overflow</a>
<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps>Add app roles and get them from a token - Microsoft identity platform | Microsoft Docs</a></p><p>👇下面的说法不对。</p><p>=====</p><p>拿到access_token 去访问 resource owner，怎么知道权限呢？scope。
kip 里面拿到acess_token，仍然是去找 microsoft graph 问他是谁，难道 ms graph 是一个 resource owner？对的。所以Azure Portal 中配置 Application 时需要在 API Permissions 中更加上MS Graph 相关的 Permission</p><p>自己的App（即resource owner，简称RO）中要加权限控制，整个配置的流程是这样的：</p><ol><li>为client app注册application：<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app>Quickstart: Register an app in the Microsoft identity platform - Microsoft identity platform | Microsoft Docs</a></li><li>为RO配置权限。文档中叫Expose an API，可以理解为RO是一个大的API，不同权限对应不同的scope。添加scope：<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-expose-web-apis>Quickstart: Register and expose a web API - Microsoft identity platform | Microsoft Docs</a></li><li>为RO添加的permission，包括了微软提供的一些permission（比如 MS Graph 的permission）和我们自己定义的scope对应的permission：<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-configure-app-access-web-apis>Quickstart: Configure an app to access a web API - Microsoft identity platform | Microsoft Doc</a></li></ol><h1 id=s端集成azure-ad-sso>S端集成Azure AD SSO</h1><h2 id=基础概念>基础概念</h2><ol><li>Azure AD是微软提供的云服务，它是一个多租户系统。公司是Azure AD的一个租户（或者叫域），对应的租户名称是kerryprops.com。我们开发时会使用一个测试用的租户，租户名称为kpltest.onmicrosoft.com。</li><li>SSO：单点登录。整个单点登录过程中，会涉及到用户、身份提供商（Identity Provider，简称IdP）和服务提供商（Service Provider，简称SP）。在S端用户登录这个场景中，Azure AD 是 IdP，S端是SP同时也是IdP（因为我们有自己的Profile Service）。整个SSO的目的就是用Azure AD的token去换回S端的token（因为调用后端Service API使用的是S端的token，而非Azure AD的token）</li><li>涉及到多个 IdP 的 SSO 有很多方式可以实现，比如 SAML 2.0，WS-Federation，OpenID Connect（OIDC）和 OAuth。S端是一个前后端分离的单页应用（SPA），采用的是<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-overview#overview>OAuth 2.0 Authorization code flow (with PKCE)</a>。页面请求顺序如下图：
<img src=./assets/admin-portal-sso.png alt=admin-portal-sso.png></li><li>MSAL库：Microsoft Authentication Library，微软官方出品的类库，可方便地处理使用Azure AD做SSO的各类场景。有各种语言的版本。JavaScript语言的版本叫 <a href=https://github.com/AzureAD/microsoft-authentication-library-for-js>MSAL.js</a></li></ol><h2 id=azure-ad上的配置>Azure AD上的配置</h2><p>这部分需要Azure AD的管理员才能配置。管理员登录到Azure AD Portal: <a href=https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade>https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade</a></p><blockquote><p>如果想自己尝试配置和管理一个Azure AD的租户，可以用个人的微软账号（比如live.com/hotmail.com/outlook.com 邮箱账号）去申请<a href=https://developer.microsoft.com/en-us/microsoft-365/dev-program>Microsoft 365 Developer Program</a>，可以得到一个免费的Azure AD租户。</p></blockquote><h2 id=s端代码说明>S端代码说明</h2><p>使用的npm pacakge：<a href=https://www.npmjs.com/package/@azure/msal-browser>@azure/msal-browser - npm</a>（就是上文说到的 MSAL.js ）</p><h3 id=配置项>配置项</h3><p>配置项写在 <code>src/store/modules/user.js</code> 中：</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#c1abea>msalLoginRequest</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#c1abea>scopes</span><span style=color:#c7bf54>:</span> [<span style=color:#98c379>&#39;openid&#39;</span>, <span style=color:#98c379>&#39;profile&#39;</span>, <span style=color:#98c379>&#39;User.Read&#39;</span>], <span style=color:#8a93a5;font-style:italic>// 对应上文中的 API Permissions
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    },
</span></span><span style=display:flex><span>    <span style=color:#c1abea>msalUseRedirect</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>process</span>.<span style=color:#c1abea>env</span>.<span style=color:#c1abea>VUE_APP_AZURE_USE_REDIRECT</span> <span style=color:#c7bf54>==</span> <span style=color:#98c379>&#39;true&#39;</span>, <span style=color:#8a93a5;font-style:italic>// 参见下文说明1
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c1abea>msalConfig</span><span style=color:#c7bf54>:</span> { <span style=color:#8a93a5;font-style:italic>// 参见下文说明2
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>      <span style=color:#c1abea>auth</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>clientId</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>getAzureConfig</span>().<span style=color:#c1abea>clientId</span>,
</span></span><span style=display:flex><span>        <span style=color:#c1abea>authority</span><span style=color:#c7bf54>:</span> <span style=color:#c1abea>getAzureConfig</span>().<span style=color:#c1abea>authority</span>, <span style=color:#8a93a5;font-style:italic>// 里面有tenantId
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#c1abea>navigateToLoginRequestUrl</span><span style=color:#c7bf54>:</span> <span style=color:#b756ff;font-weight:700>false</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#c1abea>cache</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>cacheLocation</span><span style=color:#c7bf54>:</span> <span style=color:#98c379>&#39;localStorage&#39;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ol><li>这个选项是用来控制浏览器从S端登录页到Azure AD登录页时使用跳转还是弹窗。参考这里：https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-sign-in?tabs=javascript2#choosing-between-a-pop-up-or-redirect-experience</li><li>Configuration Options完整文档在这里：https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/configuration.md</li></ol><h3 id=初始化-msal-实例>初始化 MSAL 实例</h3><p>在 <code>src/main.js</code> 中：</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#c1abea>Vue</span>.<span style=color:#c1abea>prototype</span>.<span style=color:#c1abea>$msalInstance</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>new</span> <span style=color:#c1abea>PublicClientApplication</span>(
</span></span><span style=display:flex><span>  <span style=color:#c1abea>store</span>.<span style=color:#c1abea>state</span>.<span style=color:#c1abea>user</span>.<span style=color:#c1abea>msalConfig</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><h3 id=登录>登录</h3><p>在 <code>src/views/login.vue</code> 中：</p><div class=highlight><div style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#58626f">99
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#b0c4de;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c1abea>mounted</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// ....
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// 如果从S端登录页到Azure AD登录页时使用跳转方式，当用户在Azure AD登录成功时
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// 浏览器会跳转会 /login，同时url中会带上#code=xxxxx，
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// 从code的值中可用解析出Azure AD的token
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>if</span> (<span style=color:#c678dd>this</span>.<span style=color:#c1abea>$store</span>.<span style=color:#c1abea>state</span>.<span style=color:#c1abea>user</span>.<span style=color:#c1abea>msalUseRedirect</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>code</span> <span style=color:#c7bf54>=</span> <span style=color:#ef8383>document</span>.<span style=color:#c1abea>location</span>.<span style=color:#c1abea>href</span>.<span style=color:#c1abea>split</span>(<span style=color:#98c379>&#39;#&#39;</span>).<span style=color:#c1abea>pop</span>();
</span></span><span style=display:flex><span>      <span style=color:#c678dd>if</span> (<span style=color:#c1abea>code</span> <span style=color:#c7bf54>&amp;&amp;</span> <span style=color:#c1abea>code</span>.<span style=color:#c1abea>indexOf</span>(<span style=color:#98c379>&#39;code=&#39;</span>) <span style=color:#c7bf54>===</span> <span style=color:#d19a66>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#39;AAD_SSO&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#39;Find auth code in path, starting handleRedirectPromise...&#39;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>
</span></span><span style=display:flex><span>          .<span style=color:#c1abea>handleRedirectPromise</span>()
</span></span><span style=display:flex><span>          .<span style=color:#c1abea>then</span>((<span style=color:#c1abea>resp</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(
</span></span><span style=display:flex><span>              <span style=color:#98c379>&#39;AAD_SSO&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#98c379>&#39;handleRedirectPromise on mounted done&#39;</span>,
</span></span><span style=display:flex><span>              <span style=color:#c1abea>resp</span>
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#c678dd>let</span> <span style=color:#c1abea>accessToken</span> <span style=color:#c7bf54>=</span> <span style=color:#c1abea>resp</span>.<span style=color:#c1abea>accessToken</span>;
</span></span><span style=display:flex><span>            <span style=color:#c678dd>this</span>.<span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>          })
</span></span><span style=display:flex><span>          .<span style=color:#c678dd>catch</span>((<span style=color:#c1abea>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#c1abea>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#c1abea>methods</span><span style=color:#c7bf54>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// acquireTokenSilent，成功则调用下面的msalLogin；
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// 失败则调用 getMsalAccessTokenViaInteractiveMode
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// 目前未用到
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>async</span> <span style=color:#c1abea>getMsalAccessToken</span>(<span style=color:#c1abea>account</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>request</span> <span style=color:#c7bf54>=</span> { <span style=color:#8a93a5;font-style:italic>// // 参见下文说明1
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        <span style=color:#c1abea>scopes</span><span style=color:#c7bf54>:</span> [<span style=color:#98c379>&#39;User.Read&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#c1abea>prompt</span><span style=color:#c7bf54>:</span> <span style=color:#98c379>&#39;select_account&#39;</span>,
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#c678dd>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>let</span> <span style=color:#c1abea>tokenResponse</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>.<span style=color:#c1abea>acquireTokenSilent</span>(
</span></span><span style=display:flex><span>          <span style=color:#c1abea>request</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(<span style=color:#98c379>&#39;setAccessToken&#39;</span>, <span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>      } <span style=color:#c678dd>catch</span> (<span style=color:#c1abea>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#c1abea>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(
</span></span><span style=display:flex><span>          <span style=color:#98c379>&#39;Silent token acquisition failed. Using interactive mode&#39;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>getMsalAccessTokenViaInteractiveMode</span>();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 交互模式登录：弹窗或者跳转到Azure AD登录页面，完成登录，获取到Azure AD的token
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>async</span> <span style=color:#c1abea>getMsalAccessTokenViaInteractiveMode</span>() {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#8a93a5;font-style:italic>// https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/request-response-object.md
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>      <span style=color:#c678dd>const</span> <span style=color:#c1abea>request</span> <span style=color:#c7bf54>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#c1abea>scopes</span><span style=color:#c7bf54>:</span> [<span style=color:#98c379>&#39;User.Read&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#c1abea>prompt</span><span style=color:#c7bf54>:</span> <span style=color:#98c379>&#39;select_account&#39;</span>,
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#c1abea>console</span>.<span style=color:#c1abea>info</span>(
</span></span><span style=display:flex><span>        <span style=color:#98c379>&#39;Using interactive mode to msal get access token...&#39;</span>
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#c678dd>if</span> (<span style=color:#c678dd>this</span>.<span style=color:#c1abea>$store</span>.<span style=color:#c1abea>state</span>.<span style=color:#c1abea>user</span>.<span style=color:#c1abea>msalUseRedirect</span>) {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>.<span style=color:#c1abea>acquireTokenRedirect</span>(<span style=color:#c1abea>request</span>);
</span></span><span style=display:flex><span>      } <span style=color:#c678dd>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#c678dd>let</span> <span style=color:#c1abea>tokenResponse</span> <span style=color:#c7bf54>=</span> <span style=color:#c678dd>await</span> <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$msalInstance</span>.<span style=color:#c1abea>acquireTokenPopup</span>(
</span></span><span style=display:flex><span>          <span style=color:#c1abea>request</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(
</span></span><span style=display:flex><span>          <span style=color:#98c379>`Access token acquired via interactive auth </span><span style=color:#98c379>${</span><span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span><span style=color:#98c379>}</span><span style=color:#98c379>`</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#c678dd>this</span>.<span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>tokenResponse</span>.<span style=color:#c1abea>accessToken</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// 调用profile serivce接口，用Azure AD的token去获取S端可用的token
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// 完成登录过程
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#8a93a5;font-style:italic>// Azure AD的token可以用微软提供的接口 https://graph.microsoft.com/v1.0/me 来验证
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>    <span style=color:#c678dd>async</span> <span style=color:#c1abea>msalLogin</span>(<span style=color:#c1abea>msalAccessToken</span>) {
</span></span><span style=display:flex><span>      <span style=color:#c678dd>this</span>.<span style=color:#c1abea>$store</span>
</span></span><span style=display:flex><span>        .<span style=color:#c1abea>dispatch</span>(<span style=color:#98c379>&#39;MsalLogin&#39;</span>, <span style=color:#c1abea>msalAccessToken</span>)
</span></span><span style=display:flex><span>        .<span style=color:#c1abea>then</span>(() =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>console</span>.<span style=color:#c1abea>log</span>(<span style=color:#98c379>&#39;Msal login finally done!!!&#39;</span>);
</span></span><span style=display:flex><span>          <span style=color:#8a93a5;font-style:italic>// 。。。。
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>        })
</span></span><span style=display:flex><span>        .<span style=color:#c678dd>catch</span>((<span style=color:#c1abea>e</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#c1abea>console</span>.<span style=color:#c1abea>error</span>(<span style=color:#c1abea>e</span>);
</span></span><span style=display:flex><span>          <span style=color:#c678dd>this</span>.<span style=color:#c1abea>loading</span> <span style=color:#c7bf54>=</span> <span style=color:#b756ff;font-weight:700>false</span>;
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#8a93a5;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8a93a5;font-style:italic></span>  },   
</span></span></code></pre></td></tr></table></div></div><p>说明：</p><ol><li>Request 和 Response 对象的完整文档在这里：https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/request-response-object.md</li></ol><h3 id=登出>登出</h3><p>登出时不涉及Azure AD的登出，只是删除S端自己的token即可。</p><h2 id=其他>其他</h2><h3 id=登录报错pkce-not-created>登录报错：pkce not created</h3><p>by yuyang in SKC。错误信息如下：</p><pre tabindex=0><code>uncaught (in promise) BrowserAuthError:app.24961a1a.j5:141

pkce not created: The PKCE code challenge and verifier could not be generated. Detail TypeError: Cannot read property &#39;digest&#39; of undefined at t les constructor@ (https: //static.kerryprops.com.cn/kip/kip-admin-portel/static/is/app.24361ale-j9:141:4139)

at newt (nttpst//statickerryprops.com.en/kip/kip-admin-portal/static/js/app.496181a.45/141/225355

at Function.t, createPkceNotGeneratedError (https://static.kerryprops.com.cn/kip/kip-admin-pontal/static/is/app.24961ala.js:141:22692)

at e-sanonymous&gt;/(https://static.kerryprops.com.cn/kip/kip-admin-portal/
</code></pre><p>原因：
用户没有使用https链接登录S端。使用 <a href=https://admin.kerryplus.com>https://admin.kerryplus.com</a> 访问登录成功。</p><h3 id=错误2>错误2</h3><p><a href=https://learn.microsoft.com/en-us/answers/questions/1194524/how-to-fix-aadsts9002325-proof-key-for-code-exchan>How to fix AADSTS9002325: Proof Key for Code Exchange is required for cross-origin authorization code redemption error in msal react application. - Microsoft Q&amp;A</a></p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://devblogs.microsoft.com/azure-sdk/vue-js-user-authentication/>Vue.js User Authentication and the new Azure SDKs - Azure SDK Blog</a></li><li><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications>Initialize MSAL.js client apps - Microsoft identity platform | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/scenario-spa-sign-in?tabs=javascript2">Single-page app sign-in & sign-out - Microsoft identity platform | Microsoft Docs</a></li></ul><hr width=100% id=EOF><p style=color:#777>Last modified on 2021-12-08</p></div></div><nav class=post-pagination><a class=newer-posts href=/tech-blog/posts/20220418-weixin_mp_webview/>Next<br>小程序及App内嵌H5
</a><a class=older-posts href=/tech-blog/posts/20211105-aliyun_arms/>Previous<br>uni-app 多端项目接入阿里云 ARMS</a></nav><div class=post-comment-wrapper><p style=opacity:.6 align=center><small>Comments Disabled.</small></p></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://joelz.github.io/tech-blog/><div class=nav-title>Notes by Joel</div><div class=nav-subtitle>Bytes and Bits, Piece by Piece.</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/tech-blog/posts>Archive
</a><a class="a-block nav-link-item false" href=/tech-blog/categories>Categories
</a><a class="a-block nav-link-item false" href=/tech-blog/tags>Tags
</a><a class="a-block nav-link-item false" href=/tech-blog/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copy, right? 🤔</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#%e7%ac%ac%e4%b8%89%e6%96%b9%e5%ba%94%e7%94%a8%e6%8e%a5%e5%85%a5azure-ad-sso%e6%b5%81%e7%a8%8b class=nav-第三方应用接入azure-ad-sso流程>第三方应用接入Azure AD SSO流程</a></li><li><a href=#oauth-in-azure-ad class=nav-oauth-in-azure-ad>OAuth in Azure AD</a></li><ul><li><a href=#default-access-token-%e6%98%af-jwt%e4%bd%86%e6%98%af%e6%97%a0%e6%b3%95%e9%aa%8c%e8%af%81%e7%ad%be%e5%90%8d--invalid-signature class=nav-default-access-token-是-jwt但是无法验证签名--invalid-signature>default access token 是 jwt，但是无法验证签名 Invalid signature</a></li><li><a href=#oidc-in-oauth class=nav-oidc-in-oauth>OIDC in OAuth</a></li></ul><li><a href=#saml-in-azure-ad class=nav-saml-in-azure-ad>SAML in Azure AD</a></li><ul><li><a href=#saml-%e9%85%8d%e7%bd%ae class=nav-saml-配置>SAML 配置</a></li><li><a href=#saml-in-msaljs class=nav-saml-in-msaljs>SAML in MSAL.js?</a></li><li><a href=#%e4%be%8b%e5%ad%90 class=nav-例子>例子</a></li><ul><li><a href=#saml-101 class=nav-saml-101>SAML 101</a></li></ul></ul><li><a href=#%e4%bf%9d%e6%8a%a4api class=nav-保护api>保护API</a></li></ul><li><a href=#s%e7%ab%af%e9%9b%86%e6%88%90azure-ad-sso class=nav-s端集成azure-ad-sso>S端集成Azure AD SSO</a></li><ul><li><a href=#%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5 class=nav-基础概念>基础概念</a></li><li><a href=#azure-ad%e4%b8%8a%e7%9a%84%e9%85%8d%e7%bd%ae class=nav-azure-ad上的配置>Azure AD上的配置</a></li><li><a href=#s%e7%ab%af%e4%bb%a3%e7%a0%81%e8%af%b4%e6%98%8e class=nav-s端代码说明>S端代码说明</a></li><ul><li><a href=#%e9%85%8d%e7%bd%ae%e9%a1%b9 class=nav-配置项>配置项</a></li><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96-msal-%e5%ae%9e%e4%be%8b class=nav-初始化-msal-实例>初始化 MSAL 实例</a></li><li><a href=#%e7%99%bb%e5%bd%95 class=nav-登录>登录</a></li><li><a href=#%e7%99%bb%e5%87%ba class=nav-登出>登出</a></li></ul><li><a href=#%e5%85%b6%e4%bb%96 class=nav-其他>其他</a></li><ul><li><a href=#%e7%99%bb%e5%bd%95%e6%8a%a5%e9%94%99pkce-not-created class=nav-登录报错pkce-not-created>登录报错：pkce not created</a></li><li><a href=#%e9%94%99%e8%af%af2 class=nav-错误2>错误2</a></li></ul><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 class=nav-参考链接>参考链接</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up
</i></a><a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
Copy, right? 🤔</div></div><script src=/tech-blog/js/journal.js></script></body></html>